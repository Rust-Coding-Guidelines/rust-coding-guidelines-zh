## G.VAR.05  避免局部变量导致的大量栈分配

**【级别】** 建议

**【描述】**

Rust 局部变量默认分配在栈上。当局部变量占用栈空间过大时，会栈溢出，可以采用`Box<T>`使变量在堆上分配。

Rust 默认栈分配空间为：

1. 主线程默认 `8MiB` 。
2. 运行中代码创建的子线程默认是 `2MiB` 。

也可以自行配置栈分配内存大小。

所以，局部变量占用多少空间才算过大，这个需要开发者根据具体的场景根据栈大小配置情况做出合适的预判，一般以 512 KiB为宜。

**【反例】**

```rust
let _: [i32; 8000] = [1; 8000];
```

**【正例】**

```rust
let _: Box<[i32; 8000]> = Box::new([1; 8000]);
```

**【Lint 检测】**

| lint name                                                    | Clippy 可检测 | Rustc 可检测 | Lint Group | 是否可定制 |
| ------------------------------------------------------------ | ------------- | ------------ | ---------- | ----- |
| _ | no           | no           | _   | yes |

**【定制化参考】**

这条规则如果需要定制Lint，则可以分别检测每个局部变量占用的栈空间，并统计总体占用情况，进行告警。
局部变量占用栈空间的告警阈值默认是 2MB，但是用户可以按需配置该值。

